# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:

  publish-npm:
    runs-on: ubuntu-latest
    # environment: npm
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 22
        registry-url: https://registry.npmjs.org/

    # - name: Run Unit Tests
    #   run: |
    #     npm ci
    #     npm run test

    ## - name: Run Integration Tests
    ##  run: |
    ##    npm install
    ##    npm run test:integration

    - name: get-version
      id: package-version
      # requires npm which we get from setup-node
      run: |
        echo "current-version=$(npm pkg get version | tr -d '"')" >> $GITHUB_OUTPUT

    - name: Replace TBD entry in CHANGELOG.md
      uses: actions/github-script@v7
      env:
        CURRENT_VERSION: ${{ steps.package-version.outputs.current-version }}
      with:
        script: |
          const fsp = require('node:fs/promises');
          const mdFile = 'CHANGELOG.md';
          const currentVersion = process.env.CURRENT_VERSION;

          try {
            const mdContent = await fsp.readFile(mdFile, 'utf8');
            //  /^(#+.*\d+\.\d+\.\d+.*)tbd(.*)$/im;
            const regex = new Regexp(`^(#+.*${currentVersion}.*)tbd(.*)$`, 'im');

            const currentDate = new Date().toISOString().replace(/T.*/i, '');
            const newContent = mdContent.replace(regex, `$1${currentDate}$2`);

            if (mdContent !== newContent) {
              await fsp.writeFile(mdFile, newContent);
              core.exportVariable('UPDATED', 'true');
            }
          } catch(err) {
            core.warning('Error during CHANGELOG.md modification: ' + err.message);
          }

    - run: |
        cat CHANGELOG.md

    # - name: Parse changelog
    #   id: parse-changelog
    #   uses: schwma/parse-changelog-action@v1.0.0
    #   with:
    #     version: '${{ steps.package-version.outputs.current-version }}'

    # - name: Create a GitHub release
    #   uses: ncipollo/release-action@v1
    #   with:
    #     tag: 'v${{ steps.package-version.outputs.current-version }}'
    #     body: '${{ steps.parse-changelog.outputs.body }}'

    # - run: npm publish --access public
    #   env:
    #     NODE_AUTH_TOKEN: ${{secrets.npm_token}}
